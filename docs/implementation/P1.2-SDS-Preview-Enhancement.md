# P1.2 - SDS Preview Enhancement

**Status**: âœ… Complete
**Date**: 2025-11-20
**Task**: Enhanced SDS (Song Design Spec) preview with character counting and download features

## Overview

Enhanced the SDS preview component with advanced features including syntax highlighting, character counter with color-coded warnings, copy/download functionality, and visual feedback for user actions.

## Changes Made

### 1. New Component: SDSPreview

**File**: `/apps/web/src/components/songs/SDSPreview.tsx`

Created a comprehensive SDS preview component with the following features:

#### Features Implemented

âœ… **Syntax Highlighting**
- Uses existing JsonViewer component with react-syntax-highlighter
- Dark mode theme optimized for MeatyMusic design system
- Collapsible JSON sections with depth control
- Line numbers for easy reference

âœ… **Character Counter**
- Real-time character count for composed prompt
- Support for multiple rendering engines (Suno, Udio, Default)
- Color-coded status indicators:
  - ðŸŸ¢ Green (SAFE): < 80% of limit
  - ðŸŸ¡ Yellow (WARNING): 80-95% of limit
  - ðŸ”´ Red (DANGER): > 95% of limit
- Visual warnings with actionable messages

âœ… **Copy Functionality**
- Copy full SDS JSON to clipboard
- Copy composed prompt separately
- Visual feedback with success icons
- Toast notifications for all actions
- Keyboard shortcuts:
  - `Ctrl/Cmd+C`: Copy SDS
  - `Ctrl/Cmd+Shift+C`: Copy Prompt

âœ… **Download Functionality**
- Download full SDS as JSON file
- Download composed prompt as text file
- Auto-generated filenames with timestamps
- Format: `{song-title}-{type}-{timestamp}.{ext}`
- Keyboard shortcut: `Ctrl/Cmd+S` for SDS download

âœ… **Visual Feedback**
- Success checkmarks on successful copy
- Toast notifications for all actions
- Button state changes during operations
- Clear status indicators

âœ… **Accessibility**
- Proper ARIA labels for all interactive elements
- Keyboard navigation support
- Disabled states for unavailable actions
- Keyboard shortcuts help text

#### Engine Limits Configuration

```typescript
const ENGINE_LIMITS = {
  suno: {
    style_max: 1000,
    prompt_max: 3000,
    title_max: 100,
  },
  udio: {
    style_max: 800,
    prompt_max: 2500,
    title_max: 80,
  },
  default: {
    style_max: 1000,
    prompt_max: 5000,
    title_max: 100,
  },
};
```

#### Component Props

```typescript
interface SDSPreviewProps {
  data: SDSData;
  targetEngine?: 'suno' | 'udio' | 'default';
  songTitle?: string;
  className?: string;
  testId?: string;
}
```

### 2. Updated Song Detail Page

**File**: `/apps/web/src/app/(dashboard)/songs/[id]/page.tsx`

**Changes**:
- Replaced JsonViewer with new SDSPreview component
- Removed duplicate SDS metadata cards (now in SDSPreview)
- Removed duplicate Export button in Preview tab
- Simplified Preview tab code
- Set default target engine to 'suno'

**Before**:
```tsx
<JsonViewer
  data={sdsData}
  collapsed={1}
  theme="dark"
  showLineNumbers={true}
  enableClipboard={true}
  maxHeight="600px"
/>
```

**After**:
```tsx
<SDSPreview
  data={sdsData}
  targetEngine="suno"
  songTitle={song.title}
  testId="song-sds-preview"
/>
```

### 3. Updated SDS Type Definition

**File**: `/apps/web/src/lib/api/songs.ts`

**Changes**:
- Added explicit `composed_prompt?: string` field to SDS interface
- Maintains backward compatibility with `[key: string]: unknown`

### 4. Comprehensive Test Suite

**File**: `/apps/web/src/components/songs/__tests__/SDSPreview.test.tsx`

Created complete test coverage for SDSPreview component:

#### Test Categories

1. **Rendering Tests**
   - Component renders with SDS data
   - Composed prompt section visibility
   - Full SDS JSON section
   - Keyboard shortcuts help

2. **Character Counter Tests**
   - Character count display
   - Safe status (< 80%)
   - Warning status (80-95%)
   - Danger status (> 95%)
   - Engine-specific limits (Suno, Udio, Default)

3. **Copy Functionality Tests**
   - Copy SDS JSON
   - Copy composed prompt
   - Error handling
   - Visual feedback
   - Toast notifications

4. **Download Functionality Tests**
   - Download SDS JSON
   - Download composed prompt
   - Filename generation
   - Error handling

5. **Visual Feedback Tests**
   - Success icons
   - Button state changes
   - Toast notifications

6. **Accessibility Tests**
   - ARIA labels
   - Keyboard navigation
   - Disabled states

7. **Custom Props Tests**
   - Custom className
   - Custom testId
   - Custom song title

### 5. Updated Integration Tests

**File**: `/apps/web/src/__tests__/app/(dashboard)/songs/[id]/SongDetailPreviewTab.test.tsx`

**Changes**:
- Updated mock to use SDSPreview instead of JsonViewer
- Tests still pass with new component structure
- Maintains compatibility with existing test suite

## Files Created

1. `/apps/web/src/components/songs/SDSPreview.tsx` (455 lines)
2. `/apps/web/src/components/songs/__tests__/SDSPreview.test.tsx` (575 lines)
3. `/docs/implementation/P1.2-SDS-Preview-Enhancement.md` (this file)

## Files Modified

1. `/apps/web/src/app/(dashboard)/songs/[id]/page.tsx`
   - Changed import from JsonViewer to SDSPreview
   - Simplified Preview tab content

2. `/apps/web/src/lib/api/songs.ts`
   - Added `composed_prompt?: string` to SDS interface

3. `/apps/web/src/__tests__/app/(dashboard)/songs/[id]/SongDetailPreviewTab.test.tsx`
   - Updated mocks for SDSPreview component

## Dependencies

No new dependencies required. All features use existing libraries:
- `react-syntax-highlighter` (already installed)
- `sonner` for toast notifications (already installed)
- `lucide-react` for icons (already installed)
- `@meatymusic/ui` components (already available)

## Design System Compliance

âœ… Uses @meatymusic/ui components (Button, Card, Badge)
âœ… Follows @meatymusic/tokens design system
âœ… Dark mode optimized
âœ… Consistent with existing component patterns
âœ… TypeScript strict mode compliant
âœ… Responsive design
âœ… WCAG 2.1 AA accessibility standards

## Usage Example

```tsx
import { SDSPreview } from '@/components/songs/SDSPreview';

function SongPreviewPage({ sdsData, songTitle }) {
  return (
    <SDSPreview
      data={sdsData}
      targetEngine="suno"
      songTitle={songTitle}
    />
  );
}
```

## Character Counter Examples

### Safe Status (< 80%)
```
âœ… Suno Prompt Limit
52 / 3,000 characters
1.7% SAFE
```

### Warning Status (80-95%)
```
âš ï¸ Suno Prompt Limit
2,500 / 3,000 characters
83.3% WARNING

âš  Approaching limit
The composed prompt is using 83.3% of the suno character limit.
```

### Danger Status (> 95%)
```
ðŸš¨ Suno Prompt Limit
3,100 / 3,000 characters
103.3% DANGER

ðŸš¨ Prompt exceeds limit!
The composed prompt is 100 characters over the suno limit.
You may need to shorten it before rendering.
```

## Keyboard Shortcuts

- `Ctrl/Cmd + C` - Copy full SDS JSON to clipboard
- `Ctrl/Cmd + Shift + C` - Copy composed prompt to clipboard
- `Ctrl/Cmd + S` - Download SDS JSON file

## Download Filename Format

- SDS JSON: `{song-title}-sds-{timestamp}.json`
- Composed Prompt: `{song-title}-prompt-{timestamp}.txt`

Example: `my-awesome-song-sds-2025-11-20T14-30-00.json`

## Visual Feedback

All user actions provide immediate feedback:
1. **Copy Actions**: Success checkmark + toast notification
2. **Download Actions**: Toast notification with success message
3. **Character Counter**: Real-time updates with color coding
4. **Status Warnings**: Contextual messages based on limit usage

## Testing

### Unit Tests
```bash
cd apps/web
pnpm test src/components/songs/__tests__/SDSPreview.test.tsx
```

### Integration Tests
```bash
cd apps/web
pnpm test src/__tests__/app/(dashboard)/songs/[id]/SongDetailPreviewTab.test.tsx
```

### Test Coverage
- 8 test suites
- 50+ test cases
- All edge cases covered
- Accessibility tested
- Error handling verified

## Future Enhancements

Potential improvements for future iterations:

1. **Engine Selection**
   - Add dropdown to switch between engines
   - Show multiple engine limits simultaneously

2. **Diff View**
   - Compare different versions of SDS
   - Highlight changes between versions

3. **Validation Warnings**
   - Real-time validation against schema
   - Warning for missing required fields
   - Conflict detection for style tags

4. **Export Options**
   - Export to YAML format
   - Export individual sections
   - Batch export multiple songs

5. **Search/Filter**
   - Search within JSON
   - Filter by key names
   - Highlight matching terms

## Acceptance Criteria

âœ… **Syntax Highlighting**: JSON syntax highlighting working in dark mode
âœ… **Copy Button**: Copies formatted JSON to clipboard with visual feedback
âœ… **Download Button**: Downloads JSON file with correct filename
âœ… **Character Counter**: Shows with color coding (green/yellow/red)
âœ… **Visual Feedback**: All actions provide immediate feedback
âœ… **Accessibility**: Keyboard shortcuts and ARIA labels tested

## Notes

- Component is fully backward compatible
- No breaking changes to existing API
- Existing tests updated to reflect new structure
- All MeatyMusic design patterns followed
- Token-efficient implementation
- Ready for production deployment

## References

- Engine limits: `/limits/suno_limits.json`, `/limits/engine_limits.json`
- Design system: `@meatymusic/ui`, `@meatymusic/tokens`
- Existing patterns: `JsonViewer`, `ArtifactPreview`, `ImportPreview`
- AMCS Overview: `/docs/amcs-overview.md`
- SDS PRD: `/docs/project_plans/PRDs/sds.prd.md`
