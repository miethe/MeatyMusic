{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "amcs://schemas/sds-1.0.json",
  "title": "Song Design Spec (SDS)",
  "description": "Complete specification for deterministic music generation including all entities and constraints",
  "type": "object",
  "required": [
    "title",
    "blueprint_ref",
    "style",
    "lyrics",
    "producer_notes",
    "sources",
    "prompt_controls",
    "render",
    "seed"
  ],
  "properties": {
    "title": {
      "type": "string",
      "minLength": 1,
      "maxLength": 500,
      "description": "Song title"
    },
    "blueprint_ref": {
      "type": "object",
      "required": ["genre", "version"],
      "properties": {
        "genre": {
          "type": "string",
          "minLength": 1,
          "description": "Blueprint genre (e.g., 'Christmas Pop', 'Hip-Hop')"
        },
        "version": {
          "type": "string",
          "pattern": "^\\d{4}\\.\\d{1,2}$",
          "description": "Blueprint version (e.g., '2025.11')"
        }
      },
      "additionalProperties": false
    },
    "style": {
      "$ref": "#/definitions/Style",
      "description": "Complete style specification"
    },
    "lyrics": {
      "$ref": "#/definitions/Lyrics",
      "description": "Complete lyrics specification"
    },
    "producer_notes": {
      "$ref": "#/definitions/ProducerNotes",
      "description": "Complete producer notes specification"
    },
    "persona_id": {
      "type": ["string", "null"],
      "format": "uuid",
      "description": "UUID of persona (null if none)"
    },
    "sources": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/Source"
      },
      "description": "Array of external sources for RAG"
    },
    "prompt_controls": {
      "type": "object",
      "properties": {
        "positive_tags": {
          "type": "array",
          "items": {"type": "string"},
          "default": []
        },
        "negative_tags": {
          "type": "array",
          "items": {"type": "string"},
          "default": []
        },
        "max_style_chars": {
          "type": "integer",
          "minimum": 1,
          "maximum": 5000,
          "default": 1000
        },
        "max_prompt_chars": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10000,
          "default": 5000
        }
      },
      "additionalProperties": false
    },
    "render": {
      "type": "object",
      "properties": {
        "engine": {
          "type": "string",
          "enum": ["suno", "udio", "none", "external"],
          "default": "none"
        },
        "model": {
          "type": ["string", "null"],
          "description": "Model version for the engine"
        },
        "num_variations": {
          "type": "integer",
          "minimum": 1,
          "maximum": 8,
          "default": 2
        }
      },
      "required": ["engine"],
      "additionalProperties": false
    },
    "seed": {
      "type": "integer",
      "minimum": 0,
      "description": "Global seed for deterministic generation"
    }
  },
  "additionalProperties": false,
  "definitions": {
    "Style": {
      "type": "object",
      "required": ["genre_detail", "tempo_bpm", "key", "mood", "tags"],
      "properties": {
        "genre_detail": {
          "type": "object",
          "required": ["primary"],
          "properties": {
            "primary": {"type": "string"},
            "subgenres": {
              "type": "array",
              "items": {"type": "string"},
              "default": []
            },
            "fusions": {
              "type": "array",
              "items": {"type": "string"},
              "default": []
            }
          }
        },
        "tempo_bpm": {
          "oneOf": [
            {
              "type": "integer",
              "minimum": 40,
              "maximum": 220
            },
            {
              "type": "array",
              "items": {"type": "integer", "minimum": 40, "maximum": 220},
              "minItems": 2,
              "maxItems": 2
            }
          ]
        },
        "time_signature": {
          "type": "string",
          "default": "4/4"
        },
        "key": {
          "type": "object",
          "required": ["primary"],
          "properties": {
            "primary": {
              "type": "string",
              "pattern": "^[A-G](#|b)?\\s?(major|minor)$"
            },
            "modulations": {
              "type": "array",
              "items": {"type": "string"},
              "default": []
            }
          }
        },
        "mood": {
          "type": "array",
          "items": {"type": "string"},
          "minItems": 1
        },
        "energy": {
          "type": "string",
          "enum": ["low", "medium", "high", "anthemic"]
        },
        "instrumentation": {
          "type": "array",
          "items": {"type": "string"},
          "maxItems": 3
        },
        "vocal_profile": {"type": "string"},
        "tags": {
          "type": "array",
          "items": {"type": "string"}
        },
        "negative_tags": {
          "type": "array",
          "items": {"type": "string"},
          "default": []
        }
      }
    },
    "Lyrics": {
      "type": "object",
      "required": ["language", "section_order", "constraints"],
      "properties": {
        "language": {
          "type": "string",
          "pattern": "^[a-z]{2}$",
          "default": "en"
        },
        "pov": {
          "type": "string",
          "enum": ["1st", "2nd", "3rd"]
        },
        "tense": {
          "type": "string",
          "enum": ["past", "present", "future", "mixed"]
        },
        "themes": {
          "type": "array",
          "items": {"type": "string"},
          "default": []
        },
        "rhyme_scheme": {"type": "string"},
        "meter": {"type": "string"},
        "syllables_per_line": {
          "type": "integer",
          "minimum": 4,
          "maximum": 16
        },
        "hook_strategy": {
          "type": "string",
          "enum": ["melodic", "lyrical", "call-response", "chant"]
        },
        "repetition_policy": {
          "type": "string",
          "enum": ["sparse", "moderate", "hook-heavy"]
        },
        "imagery_density": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "reading_level": {"type": "string"},
        "section_order": {
          "type": "array",
          "items": {"type": "string"},
          "minItems": 1
        },
        "constraints": {
          "type": "object",
          "properties": {
            "explicit": {
              "type": "boolean",
              "default": false
            },
            "max_lines": {
              "type": "integer",
              "minimum": 1
            },
            "section_requirements": {
              "type": "object",
              "additionalProperties": {
                "type": "object",
                "properties": {
                  "min_lines": {"type": "integer", "minimum": 0},
                  "max_lines": {"type": "integer", "minimum": 1},
                  "must_end_with_hook": {"type": "boolean"}
                }
              }
            }
          }
        },
        "source_citations": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["source_id", "weight"],
            "properties": {
              "source_id": {"type": "string"},
              "weight": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              }
            }
          },
          "default": []
        }
      }
    },
    "ProducerNotes": {
      "type": "object",
      "required": ["structure", "hooks"],
      "properties": {
        "structure": {"type": "string"},
        "hooks": {
          "type": "integer",
          "minimum": 0
        },
        "instrumentation": {
          "type": "array",
          "items": {"type": "string"},
          "default": []
        },
        "section_meta": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "tags": {
                "type": "array",
                "items": {"type": "string"}
              },
              "target_duration_sec": {
                "type": "integer",
                "minimum": 1
              }
            }
          }
        },
        "mix": {
          "type": "object",
          "properties": {
            "lufs": {"type": "number"},
            "space": {"type": "string"},
            "stereo_width": {
              "type": "string",
              "enum": ["narrow", "normal", "wide"]
            }
          }
        }
      }
    },
    "Source": {
      "type": "object",
      "required": ["name", "kind", "mcp_server_id"],
      "properties": {
        "name": {"type": "string"},
        "kind": {
          "type": "string",
          "enum": ["file", "web", "api"]
        },
        "config": {
          "type": "object",
          "default": {}
        },
        "scopes": {
          "type": "array",
          "items": {"type": "string"},
          "default": []
        },
        "weight": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "default": 0.5
        },
        "allow": {
          "type": "array",
          "items": {"type": "string"},
          "default": []
        },
        "deny": {
          "type": "array",
          "items": {"type": "string"},
          "default": []
        },
        "provenance": {
          "type": "boolean",
          "default": true
        },
        "mcp_server_id": {"type": "string"}
      }
    }
  }
}
